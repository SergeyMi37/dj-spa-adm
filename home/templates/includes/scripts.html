{% load static %}

<!-- jQuery -->
<script src="{% static 'plugins/jquery/jquery.min.js' %}"></script>
<!-- Bootstrap 4 -->
<script src="{% static 'plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<!-- AdminLTE App -->
<script src="{% static 'dist/js/adminlte.min.js' %}"></script>
<!-- AdminLTE for demo purposes -->
<script src="{% static 'dist/js/demo.js' %}"></script>

<!-- SPA loading script -->
<script>
let spaLoaded = false;

function loadSPAPage(tabId = 1) {
    console.log('Starting SPA page load...', 'Tab ID:', tabId);
    
    // Сохраняем ID выбранной вкладки в глобальной переменной
    window.selectedTabId = tabId;
    console.log('Selected tab ID set to:', window.selectedTabId);

    // // Если SPA уже загружен, просто показываем его
    // if (spaLoaded) {
    //     console.log('SPA already loaded, showing existing content');
    //     const contentWrapper = document.querySelector('.content-wrapper');
    //     if (contentWrapper) {
    //         const appElement = contentWrapper.querySelector('#app');
    //         if (appElement) {
    //             appElement.style.display = 'block';
    //             console.log('SPA content shown');
    //         }
    //     }
    //     return;
    // }

    // Загружаем SPA контент в content-wrapper
    fetch('/my-spa-page/')
        .then(response => {
            console.log('Fetch response status:', response.status);
            return response.text();
        })
        .then(html => {
            console.log('HTML received, length:', html.length);
            console.log('HTML preview:', html.substring(0, 500) + '...');
            console.log('Checking for currentUser in HTML...');
            const userMatch = html.match(/window\.currentUser\s*=\s*({[^}]*})/);
            console.log('currentUser found in HTML:', !!userMatch);
            if (userMatch) {
                console.log('currentUser value:', userMatch[1]);
            }

            // Находим content-wrapper и заменяем его содержимое
            const contentWrapper = document.querySelector('.content-wrapper');
            console.log('Content wrapper found:', !!contentWrapper);

            if (contentWrapper) {
                // Парсим HTML и извлекаем только нужную часть
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const appElement = doc.getElementById('app');
                console.log('App element found:', !!appElement);

                if (appElement) {
                    console.log('Replacing content wrapper HTML');
                    contentWrapper.innerHTML = appElement.outerHTML;
                    spaLoaded = true;

                    // Выполняем скрипты
                    const scripts = doc.querySelectorAll('script');
                    console.log('Scripts found:', scripts.length);

                    scripts.forEach((script, index) => {
                        console.log(`Processing script ${index + 1}:`, script.src || 'inline script');
                        if (script.src) {
                            // Определяем тип скрипта
                            const isModule = script.src.endsWith('.js') && script.type === 'module';
                            const newScript = document.createElement('script');
                            newScript.src = script.src;
                            if (isModule) {
                                newScript.type = 'module';
                            }
                            newScript.onload = () => {
                                console.log(`Script ${script.src} loaded successfully`);
                                // Если это модульный скрипт, монтируем Vue
                                if (isModule) {
                                    console.log('Module script loaded, mounting Vue...');
                                    if (typeof window.mountVueApp === 'function') {
                                        try {
                                            // Передаем selectedTabId в Vue приложение
                                            window.mountVueApp(window.selectedTabId);
                                        } catch (e) {
                                            console.error('Error mounting Vue app:', e);
                                        }
                                    } else {
                                        console.log('Vue mounting function not found, trying global approach...');
                                        // Альтернативный способ передачи параметра
                                        window.mountVueApp = function(tabId) {
                                            // Устанавливаем глобальную переменную для Vue
                                            window.currentTabId = tabId;
                                        };
                                    }
                                }
                            };
                            newScript.onerror = (e) => console.error(`Script ${script.src} failed to load:`, e);
                            document.head.appendChild(newScript);
                        } else {
                            try {
                                console.log('Executing inline script, content length:', script.textContent.length);
                                console.log('Script content preview:', script.textContent.substring(0, 100) + '...');
                                // Проверяем, содержит ли скрипт JSON.parse
                                if (script.textContent.includes('JSON.parse')) {
                                    console.log('Script contains JSON.parse, handling carefully...');
                                    // Выполняем скрипт в безопасном контексте
                                    const scriptContent = script.textContent.replace(/JSON\.parse\('([^']+)'\)/g, (match, jsonStr) => {
                                        try {
                                            // Заменяем Python-стиль на JavaScript-стиль
                                            const jsJsonStr = jsonStr
                                                .replace(/\\u0027/g, "'")  // Unicode escape для одинарных кавычек
                                                .replace(/\\u0022/g, '"')  // Unicode escape для двойных кавычек
                                                .replace(/'/g, '"')  // одинарные кавычки на двойные
                                                .replace(/\bTrue\b/g, 'true')  // True -> true
                                                .replace(/\bFalse\b/g, 'false')  // False -> false
                                                .replace(/\bNone\b/g, 'null');  // None -> null
                                            const parsed = JSON.parse(jsJsonStr);
                                            return JSON.stringify(parsed);
                                        } catch (e) {
                                            console.error('JSON parse error in script:', e, 'Original string:', jsonStr);
                                            return 'null';
                                        }
                                    });
                                    eval(scriptContent);
                                } else {
                                    eval(script.textContent);
                                }
                                console.log('Inline script executed successfully');
                            } catch (e) {
                                console.error('Error executing inline script:', e);
                            }
                        }
                    });
                } else {
                    console.error('App element not found in HTML');
                    contentWrapper.innerHTML = '<div class="alert alert-danger">Ошибка: элемент приложения не найден</div>';
                }
            } else {
                console.error('Content wrapper not found');
                // Показать желтое всплывающее окно
                const toast = document.createElement('div');
                toast.className = 'alert alert-warning alert-dismissible fade show position-fixed';
                toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                toast.innerHTML = '<strong>Откройте Главное меню</strong><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>';
                document.body.appendChild(toast);
                // Автоматически скрыть через 5 секунд
                setTimeout(() => {
                    $(toast).alert('close');
                }, 5000);
            }
        })
        .catch(error => {
            console.error('Error loading SPA:', error);
            const contentWrapper = document.querySelector('.content-wrapper');
            if (contentWrapper) {
                contentWrapper.innerHTML = '<div class="alert alert-danger">Ошибка загрузки SPA: ' + error.message + '</div>';
            }
        });
}

// Функция для инициализации Vue приложения
function initVueApp() {
    console.log('Initializing Vue application...');
    // Для ES6 модулей Vue приложение должно быть уже создано в модуле
    // Проверяем, что элемент #app есть в DOM
    const appElement = document.getElementById('app');
    if (appElement) {
        console.log('Vue app element found, checking if Vue is mounted...');
        // Vue должен был уже смонтироваться при загрузке модуля
        // Проверяем, есть ли контент в элементе #app
        if (appElement.innerHTML.trim().length > 0) {
            console.log('Vue app appears to be mounted successfully');
        } else {
            console.log('Vue app element is empty, might not be mounted yet');
        }
    } else {
        console.log('Vue app element not found');
    }
}


</script>